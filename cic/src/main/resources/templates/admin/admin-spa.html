<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <!-- Common Meta Tags -->
  <th:block th:replace="~{fragments/common/head :: meta}"></th:block>
  
  <title>CIC Admin</title>
  
  <!-- Common Fonts -->
  <th:block th:replace="~{fragments/common/head :: fonts}"></th:block>
  
  <!-- Admin CSS -->
  <link rel="stylesheet" th:href="@{/css/common/variables.css}">
  <link rel="stylesheet" th:href="@{/css/common/reset.css}">
  <link rel="stylesheet" th:href="@{/css/common/spinner.css}">
  <link rel="stylesheet" th:href="@{/css/components/message-box.css}">
  <link rel="stylesheet" th:href="@{/css/common/filter.css}">
  <link rel="stylesheet" th:href="@{/css/common/pagination.css}">
  <link rel="stylesheet" th:href="@{/css/admin/admin.css}">
</head>
<body>
  <!-- Admin Sidebar Component -->
  <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

  <!-- Main Content Area -->
  <div class="main-content">
    
    <!-- Dashboard Page -->
    <div id="dashboard-page" class="admin-page active">
      <div th:replace="~{admin/fragments/sidebar :: page-header('Dashboard', 'Welcome to the admin panel')}"></div>
      
      <!-- Enhanced Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="stat-info">
            <h3 id="totalCategories">0</h3>
            <p>Total Categories</p>
          </div>
        </div>

        <div class="stat-card stat-secondary">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div class="stat-info">
            <h3 id="totalUsers">0</h3>
            <p>Total Users</p>
          </div>
        </div>

        <div class="stat-card stat-success">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 12l2 2 4-4"></path>
              <circle cx="12" cy="12" r="9"></circle>
            </svg>
          </div>
          <div class="stat-info">
            <h3 id="activeUsers">0</h3>
            <p>Active Users</p>
          </div>
        </div>

        <div class="stat-card stat-warning">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </div>
          <div class="stat-info">
            <h3 id="inactiveUsers">0</h3>
            <p>Inactive Users</p>
          </div>
        </div>

        <div class="stat-card stat-info">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="stat-info">
            <h3 id="totalMessages">0</h3>
            <p>Total Messages</p>
          </div>
        </div>

        <div class="stat-card stat-primary">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
          </div>
          <div class="stat-info">
            <h3 id="totalChats">0</h3>
            <p>Total Chats</p>
          </div>
        </div>

        <div class="stat-card stat-danger">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
          </div>
          <div class="stat-info">
            <h3 id="bannedUsers">0</h3>
            <p>Banned Users</p>
          </div>
        </div>
      </div>

      <!-- Category Feedback Ratios Section -->
      <div class="category-feedback-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 9V5a3 3 0 0 0-6 0v4"></path>
                <rect x="2" y="9" width="20" height="12" rx="2" ry="2"></rect>
              </svg>
              Category Feedback Ratios
            </h3>
            <div class="chart-controls">
              <button id="refreshCategoryFeedback" class="btn-icon" title="Refresh Data">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="category-feedback-content">
            <div id="categoryFeedbackList" class="category-feedback-list">
              <div class="feedback-loading">
                <div class="loading-spinner"></div>
                <p>Loading category feedback data...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Statistics Panel -->
      <div class="stats-panel">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
              Quick Statistics
            </h3>
          </div>
          <div class="stats-summary">
            <div class="summary-item">
              <div class="summary-label">Most Active Category</div>
              <div class="summary-value" id="mostActiveCategory">Loading...</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Average Messages per User</div>
              <div class="summary-value" id="avgMessagesPerUser">0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">User Registration Trend</div>
              <div class="summary-value" id="registrationTrend">+0% this month</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">System Health</div>
              <div class="summary-value system-health" id="systemHealth">
                <span class="health-indicator healthy"></span>
                Operational
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Categories Page -->
    <div id="categories-page" class="admin-page">
      <div id="categoriesView" class="view-fragment">
        <div th:replace="~{admin/fragments/sidebar :: page-header('Categories', 'Manage knowledge base categories')}"></div>

        <div class="categories-grid" id="categoriesGrid">
          <button class="btn-add-category" id="addCategoryBtn">
            <span class="add-icon">
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </span>
            <span>Add New Category</span>
          </button>
        </div>
      </div>
    </div>

    <div id="editor-page" class="view-fragment" style="display: none;">
        <div th:replace="~{admin/fragments/sidebar :: back-button('backFromEditor', 'Back')}"></div>

        <div th:replace="~{admin/fragments/sidebar :: page-header('Editor', 'Edit the content and manage preset questions')}"></div>

        <!-- Content Editor Section -->
        <div class="card">
          <div class="content-editor-container">
            <div class="section-header">
              <h3>Editor</h3>
              <p>Manage category content</p>
            </div>
            <div class="form-group">
              <label>Category</label>
              <div class="category-selector-container">
                <select id="editorCategory">
                  <option value="">Select a category</option>
                </select>
                <button type="button" class="btn-edit-category" id="editCategoryBtn" title="Edit category name">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>
                </button>
              </div>
              <div class="category-name-editor" id="categoryNameEditor" style="display: none;">
                <input type="text" id="categoryNameInput" placeholder="Enter new category name" />
                <div class="category-name-actions">
                  <button type="button" class="btn btn-sm btn-secondary" id="cancelEditCategoryBtn">Cancel</button>
                  <button type="button" class="btn btn-sm btn-primary" id="saveEditCategoryBtn">Save</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Content</label>
              <textarea id="editorAnswer" placeholder="Enter content..."></textarea>
            </div>

            <div class="content-editor-actions">
              <button class="btn btn-warning" id="clearContentBtn">Clear Content</button>
              <button class="btn btn-primary" id="saveContentBtn">Save Content</button>
            </div>
          </div>
        </div>

        <!-- Preset Questions Editor Section -->
        <div class="card">
          <div class="preset-editor-container">
            <div class="preset-section" id="presetSection">
              <div class="preset-section-header">
                <div class="preset-section-title">
                  <svg class="preset-icon-header" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z" />
                  </svg>
                  <span>Preset Questions</span>
                  <span class="preset-counter" id="presetCounter">0</span>
                </div>
                <button class="btn-add-preset" id="btnAddPreset">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                  </svg>
                  <span>Add Preset</span>
                </button>
              </div>

              <!-- Preset Input Container -->
              <div class="preset-input-container" id="presetInputContainer">
                <div class="preset-input-wrapper">
                  <input type="text" id="presetQuestionInput"
                    placeholder="Enter a preset question (e.g., 'What are the library hours?')" maxlength="200" />
                  <div class="preset-input-actions">
                    <button class="btn-icon btn-icon-primary" id="btnSavePreset" title="Save">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                      </svg>
                    </button>
                    <button class="btn-icon btn-icon-secondary" id="btnCancelPreset" title="Cancel">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Preset List -->
              <div id="presetListContainer">
                <div class="preset-list" id="presetList">
                  <!-- Preset items will be dynamically added here -->
                </div>

                <!-- Empty State -->
                <div class="preset-empty-state" id="presetEmptyState">
                  <svg class="preset-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                  </svg>
                  <p>No preset questions yet</p>
                  <small>Add quick questions to help users navigate this category</small>
                </div>
              </div>

              <div class="preset-editor-actions">
                <button class="btn btn-warning" id="clearPresetsBtn">Clear Presets</button>
                <button class="btn btn-primary" id="savePresetsBtn">Save Presets</button>
              </div>
            </div>
          </div>
      </div>
      <div class="global-actions">
          <button class="btn btn-secondary" id="cancelEditorBtn">Cancel</button>
        </div>
    </div>

    <!-- Users Page -->
    <div id="users-page" class="admin-page">
      <div th:replace="~{admin/fragments/sidebar :: page-header('Users Management', 'Manage user accounts and permissions')}"></div>
      
      <!-- Filter Section -->
      <div class="filter-container">
        <button class="filter-toggle-btn" id="filterToggleBtn">
          <svg class="filter-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          <span>Filter</span>
        </button>
        
        <div class="filter-panel" id="filterPanel">
          <div class="filter-content">
            <div class="filter-section">
              <label class="filter-label">Filter by Role:</label>
              <div class="filter-options">
                <button class="filter-option active" data-filter-type="role" data-value="all">All Users</button>
                <button class="filter-option" data-filter-type="role" data-value="admin">Admin</button>
                <button class="filter-option" data-filter-type="role" data-value="student">Student</button>
              </div>
            </div>
            
            <div class="filter-section">
              <label class="filter-label">Filter by Login Status:</label>
              <div class="filter-options">
                <button class="filter-option active" data-filter-type="login" data-value="all">All</button>
                <button class="filter-option" data-filter-type="login" data-value="recent">Recently Active</button>
                <button class="filter-option" data-filter-type="login" data-value="inactive">Inactive</button>
              </div>
            </div>

            <div class="filter-section">
              <label class="filter-label">Filter by Status:</label>
              <div class="filter-options">
                <button class="filter-option active" data-filter-type="banned" data-value="all">All Status</button>
                <button class="filter-option" data-filter-type="banned" data-value="active">Active Only</button>
                <button class="filter-option" data-filter-type="banned" data-value="banned">Banned Only</button>
              </div>
            </div>

            <div class="filter-section">
              <label class="filter-label">Search by Name/Email:</label>
              <input type="text" class="filter-search" id="searchInput" placeholder="Search users...">
            </div>

            <div class="filter-actions">
              <button class="filter-clear-btn" id="clearFiltersBtn">Clear All Filters</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="table-container">
          <table class="user-table">
            <thead>
              <tr>
                <th></th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Joined</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr class="empty-row">
                <td colspan="6">
                  <div th:replace="~{admin/fragments/sidebar :: empty-state('No users found.')}"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
          <div class="pagination-info">
            <span id="paginationInfo">Showing 1-10 of 50</span>
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" id="firstPageBtn" title="First Page">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="11 17 6 12 11 7"></polyline>
                <polyline points="18 17 13 12 18 7"></polyline>
              </svg>
            </button>
            <button class="pagination-btn" id="prevPageBtn" title="Previous Page">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            
            <div class="pagination-numbers" id="paginationNumbers"></div>
            
            <button class="pagination-btn" id="nextPageBtn" title="Next Page">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
            <button class="pagination-btn" id="lastPageBtn" title="Last Page">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="13 17 18 12 13 7"></polyline>
                <polyline points="6 17 11 12 6 7"></polyline>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Loading Overlay Component -->
  <div th:replace="~{fragments/common/loading-overlay :: loading-overlay}"></div>

  <!-- Message Box Component -->
  <div th:replace="~{fragments/common/message-box :: message-box}"></div>

  <!-- Terminal Component -->
  <div th:replace="~{admin/fragments/terminal :: terminal}"></div>
  
  <!-- Admin Terminal Script -->
  <script th:src="@{/js/admin/managers/terminal-manager.js}"></script>

  <!-- Terminal Initialization -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const terminalInput = document.getElementById('terminalInput');
      const terminalOutput = document.getElementById('terminalOutput');
      
      if (terminalInput && terminalOutput) {
        window.terminal = new TerminalManager(terminalInput, terminalOutput);
      }
    });
  </script>

  <!-- Sidebar Toggle Script -->
  <script th:src="@{/js/admin/sidebar-toggle.js}"></script>
  
  <!-- Terminal Position Update Script -->
  <script>
    document.addEventListener('sidebarToggle', function(event) {
      const terminal = document.querySelector('.terminal-container');
      if (terminal) {
        if (event.detail.isCollapsed) {
          terminal.style.left = '80px';
        } else {
          terminal.style.left = '280px';
        }
      }
    });
  </script>
  
  <!-- Common Scripts -->
  <th:block th:replace="~{fragments/common/scripts :: common-scripts}"></th:block>
  
  <!-- Admin Resource Loader (must load first) -->
  <script th:src="@{/js/admin/admin-resource-loader.js}"></script>
  
  <!-- Resource Loading Indicator -->
  <script th:src="@{/js/admin/components/resource-loading-indicator.js}"></script>

  <!-- All component scripts -->
  <script th:src="@{/js/admin/components/modal.js}"></script>
  <script th:src="@{/js/admin/components/dropdown.js}"></script>
  <script th:src="@{/js/admin/components/filter.js}"></script>
  <script th:src="@{/js/admin/components/pagination.js}"></script>

  <!-- All manager scripts -->
  <script th:src="@{/js/admin/managers/user-manager.js}"></script>
  <script th:src="@{/js/admin/managers/category-manager.js}"></script>
  <script th:src="@{/js/admin/managers/preset-manager.js}"></script>

  <!-- All page scripts -->
  <script th:src="@{/js/admin/pages/dashboard-page.js}"></script>
  <script th:src="@{/js/admin/pages/users-page.js}"></script>
  <script th:src="@{/js/admin/pages/categories-page.js}"></script>
  <script th:src="@{/js/admin/pages/editor-page.js}"></script>
  
  <!-- SPA Navigation Script -->
  <script th:src="@{/js/admin/spa-navigation.js}"></script>
  
  <!-- Global logout function -->
  <script>
    function logout() {
      if (window.auth) {
        window.auth.signOut();
      } else {
        window.location.href = '/cic/auth/sign-in';
      }
    }
  </script>
</body>
</html>